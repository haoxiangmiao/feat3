<?xml version="1.0" encoding="UTF-8"?>
<Worksheet>
<Version major="2015" minor="0"/>
<Label-Scheme value="2" prefix=""/>
<View-Properties presentation="false" autoexpanding_sections="true" UserProfileName="Maple Default Profile" NumericFormat-ApplyInteger="true" NumericFormat-ApplyRational="true" NumericFormat-ApplyExponent="false">
</View-Properties>
<MapleNet-Properties elisiondigitsbefore="100" labelling="true" indentamount="4" elisiontermsthreshold="10000" ansi="false" errorbreak="1" useclientjvm="true" echo="1" imaginaryunit="I" labelwidth="20" unitattributes="&quot;fontweight&quot; = &quot;bold&quot;" contextmenusize="automatic" plotdriver="opengl" elisiondigitsafter="100" plotoutput="terminal" helpbrowser="standard" rtablesize="10" elisiontermsbefore="100" elisiondigitsthreshold="10000" typesetting="extended" plotdevice="inline" verboseproc="1" showassumed="1" quiet="false" errorcursor="false" longdelim="true" plotoptions="" elisiontermsafter="100" screenwidth="79" preplot="" prettyprint="3" displayprecision="-1" screenpixelheight="1080" warnlevel="3" screenheight="25" latexwidth="8.0" postplot="" prompt="&gt; " ShowLabels="true"/>
<Styles>
<Font name="Ordered List 1" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Annotation Text" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Ordered List 2" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Ordered List 3" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Ordered List 4" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Ordered List 5" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Author" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Annotation Title" background="[255,255,255]" bold="true" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="18" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Warning" background="[0,0,0]" bold="false" executable="false" family="Monospaced" foreground="[0,0,255]" italic="false" opaque="false" readonly="true" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Caption Reference" background="[255,255,255]" bold="true" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Maple Input Placeholder" background="[255,255,255]" bold="true" executable="true" family="Courier New" foreground="[200,0,200]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="true"/>
<Font name="Maple Plot" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Code" background="[255,255,255]" bold="false" executable="false" family="Courier New" foreground="[255,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Line Printed Output" background="[255,255,255]" bold="false" executable="false" family="Courier New" foreground="[0,0,255]" italic="false" opaque="false" readonly="true" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Text Output" background="[255,255,255]" bold="false" executable="false" family="Courier New" foreground="[0,0,255]" italic="false" opaque="false" readonly="true" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Diagnostic" background="[255,255,255]" bold="false" executable="false" family="Courier New" foreground="[40,120,40]" italic="false" opaque="false" readonly="true" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="2D Inert Output" background="[255,255,255]" bold="false" executable="true" family="Times New Roman" foreground="[144,144,144]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Normal" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Hyperlink" background="[255,255,255]" bold="false" executable="false" family="Times New Roma" foreground="[0,128,128]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="true" placeholder="false"/>
<Font name="Maple Output" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Dash Item" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="2D Math" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Maple Input" background="[0,0,0]" bold="true" executable="true" family="Monospaced" foreground="[255,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="2D Output" background="[0,0,0]" bold="false" executable="false" family="Lucida Bright" foreground="[0,0,255]" italic="false" opaque="false" readonly="true" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="2D Input" background="[255,255,255]" bold="false" executable="true" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="HyperlinkError" background="[255,255,255]" bold="false" executable="false" family="Courier New" foreground="[255,0,255]" italic="false" opaque="false" readonly="true" size="12" subscript="false" superscript="false" underline="true" placeholder="false"/>
<Font name="Header and Footer" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="10" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Error" background="[0,0,0]" bold="false" executable="false" family="Monospaced" foreground="[255,0,255]" italic="false" opaque="false" readonly="true" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Title" background="[255,255,255]" bold="true" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="18" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Heading 1" background="[255,255,255]" bold="true" executable="false" family="Times New Roma" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="18" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Text" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Bullet Item" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Heading 4" background="[255,255,255]" bold="false" executable="false" family="Times New Roma" foreground="[0,0,0]" italic="true" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Equation Label" background="[255,255,255]" bold="true" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Heading 3" background="[255,255,255]" bold="true" executable="false" family="Times New Roma" foreground="[0,0,0]" italic="true" opaque="false" readonly="false" size="14" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Heading 2" background="[255,255,255]" bold="true" executable="false" family="Times New Roma" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="16" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="HyperlinkWarning" background="[255,255,255]" bold="false" executable="false" family="Courier New" foreground="[0,0,255]" italic="false" opaque="false" readonly="true" size="12" subscript="false" superscript="false" underline="true" placeholder="false"/>
<Font name="Dictionary Hyperlink" background="[255,255,255]" bold="false" executable="false" family="Times New Roma" foreground="[147,0,15]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="true" placeholder="false"/>
<Font name="Atomic Variable" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[175,0,175]" italic="true" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="Caption Text" background="[255,255,255]" bold="true" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Font name="List Item" background="[255,255,255]" bold="false" executable="false" family="Times New Roman" foreground="[0,0,0]" italic="false" opaque="false" readonly="false" size="12" subscript="false" superscript="false" underline="false" placeholder="false"/>
<Layout name="Ordered List 1" alignment="left" bullet="numeric" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="3" spacebelow="3" linebreak="space" pagebreak-before="false" initial="-1" bulletsuffix=""/>
<Layout name="Ordered List 2" alignment="left" bullet="alphabetic" firstindent="0" leftmargin="36" rightmargin="0" linespacing="0.0" spaceabove="3" spacebelow="3" linebreak="space" pagebreak-before="false" initial="-1" bulletsuffix=""/>
<Layout name="Ordered List 3" alignment="left" bullet="roman" firstindent="0" leftmargin="72" rightmargin="0" linespacing="0.0" spaceabove="3" spacebelow="3" linebreak="space" pagebreak-before="false" initial="-1" bulletsuffix=""/>
<Layout name="Ordered List 4" alignment="left" bullet="ALPHABETIC" firstindent="0" leftmargin="108" rightmargin="0" linespacing="0.0" spaceabove="3" spacebelow="3" linebreak="space" pagebreak-before="false" initial="-1" bulletsuffix=""/>
<Layout name="Ordered List 5" alignment="left" bullet="ROMAN" firstindent="0" leftmargin="144" rightmargin="0" linespacing="0.0" spaceabove="3" spacebelow="3" linebreak="space" pagebreak-before="false" initial="-1" bulletsuffix=""/>
<Layout name="Author" alignment="centred" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="8" spacebelow="8" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Warning" alignment="left" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="0" spacebelow="0" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Annotation Title" alignment="centred" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="12" spacebelow="12" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Maple Plot" alignment="centred" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="0" spacebelow="0" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Line Printed Output" alignment="left" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="0" spacebelow="0" linebreak="any" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Text Output" alignment="left" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="0" spacebelow="0" linebreak="newline" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Diagnostic" alignment="left" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="0" spacebelow="0" linebreak="any" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Normal" alignment="left" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="0" spacebelow="0" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Maple Output" alignment="centred" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.5" spaceabove="0" spacebelow="0" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Dash Item" alignment="left" bullet="dash" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="3" spacebelow="3" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="HyperlinkError" alignment="left" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="0" spacebelow="0" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Error" alignment="left" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="0" spacebelow="0" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Title" alignment="centred" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="12" spacebelow="12" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Heading 1" alignment="left" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="8" spacebelow="4" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Bullet Item" alignment="left" bullet="dot" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="3" spacebelow="3" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Heading 4" alignment="left" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="0" spacebelow="0" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Heading 3" alignment="left" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="0" spacebelow="0" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="Heading 2" alignment="left" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="8" spacebelow="2" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="HyperlinkWarning" alignment="left" bullet="none" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="0" spacebelow="0" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Layout name="List Item" alignment="left" bullet="indent" firstindent="0" leftmargin="0" rightmargin="0" linespacing="0.0" spaceabove="3" spacebelow="3" linebreak="space" pagebreak-before="false" initial="0" bulletsuffix=""/>
<Pencil-style name="Pencil 5" pen-color="[255,0,0]" pen-height="5.0" pen-width="5.0" pen-opacity="1.0"/>
<Pencil-style name="Pencil 4" pen-color="[0,0,255]" pen-height="3.0" pen-width="3.0" pen-opacity="1.0"/>
<Pencil-style name="Pencil 3" pen-color="[0,0,0]" pen-height="3.0" pen-width="3.0" pen-opacity="1.0"/>
<Pencil-style name="Pencil 2" pen-color="[0,0,255]" pen-height="1.0" pen-width="1.0" pen-opacity="1.0"/>
<Pencil-style name="Pencil 1" pen-color="[0,0,0]" pen-height="1.0" pen-width="1.0" pen-opacity="1.0"/>
<Highlighter-style name="Highlighter 2" pen-color="[255,204,0]" pen-height="14.0" pen-width="14.0" pen-opacity="0.8"/>
<Highlighter-style name="Highlighter 1" pen-color="[255,153,255]" pen-height="12.0" pen-width="8.0" pen-opacity="0.8"/>
<Highlighter-style name="Highlighter 4" pen-color="[0,255,255]" pen-height="32.0" pen-width="32.0" pen-opacity="0.8"/>
<Highlighter-style name="Highlighter 3" pen-color="[51,255,0]" pen-height="24.0" pen-width="24.0" pen-opacity="0.8"/>
<Highlighter-style name="Highlighter 5" pen-color="[255,255,0]" pen-height="48.0" pen-width="48.0" pen-opacity="0.8"/>
</Styles>
<Startup-Code startupcode=""/>
<Task-table>
    <Task-category name="&lt;default&gt;"/>
</Task-table>
<Annotation-table>
    <Annotation-category name="&lt;default&gt;"/>
</Annotation-table>
<Task/>
<Group labelreference="L3">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">with(LinearAlgebra);with(CodeGeneration);</Text-field>
</Input>
</Group>
<Group labelreference="L4">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># Space dimension
d := 2;
# Number of basis functions for the local transformation
nphi := 2^d; xmat := Matrix(nphi,d,symbol=x);
# h will hold the local vector of optimal scales
hvec := Vector(d,symbol=h);
# xi is the vector of coordinates on the Rumpf reference element
xivec := Vector(d,symbol=xi);
# Vertex coordinates of the Rumpf reference element
xref:=Matrix([[-1,-1],[1,-1],[-1,1],[1,1]]);
# Vertex coordinates of the Rumpf reference element on the optimal scale
xh := Matrix([ [-h[1],-h[2]],[h[1],-h[2]],[ -h[1],h[2]],[h[1],h[2]]]);</Text-field>
</Input>
</Group>
<Group labelreference="L5">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># Bilinear basis functions for the transformation from the reference element to the physical element
phi[1](xi) := 1/4*(1 - xi[1] + (-1 + xi[1])*xi[2]);
phi[2](xi) := 1/4*(1 + xi[1] + (-1 - xi[1])*xi[2]);
phi[3](xi) := 1/4*(1 - xi[1] + ( 1 - xi[1])*xi[2]);
phi[4](xi) := 1/4*(1 + xi[1] + ( 1 + xi[1])*xi[2]);</Text-field>
</Input>
</Group>
<Group labelreference="L6">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># R is the transformation from the Rumpf reference element to the physical element defined by x
for j from 1 to d do
  R[j](x,xi):= simplify(eval(add(phi[i]( xi )*xmat[i,j],i=1..nphi),xi=Vector([ xi[1]/h[1], xi[2]/h[2] ])));
end do;</Text-field>
</Input>
</Group>
<Group labelreference="L7">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># gradR is the gradient of the transformation from the Rumpf reference element to the physical element
tmp := Matrix(d);
for j from 1 to d do
  for i from 1 to d do
     tmp[i,j]:=(diff(R[i](x,xi),xi[j]));
  end do
end do;
gradR := (x,xi) -&gt; Matrix(tmp);
gradR(x,xi);</Text-field>
</Input>
</Group>
<Group labelreference="L10">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">exponent_det := 1;
integrand_det := simplify(Determinant(gradR(x,xi)))^exponent_det;
# Integrate det over the Rumpf reference cell
# Divide by the ratio (Rumpf reference cell's volume)/(vanilla reference cell's volume)
# so the result is independent of the absolute scaling, otherwise the sum over all elements would vary with the refinement level
det_A := (int(int(integrand_det,xi[1]=-h[1]..h[1]),xi[2]=-h[2]..h[2]))/(h[1]*h[2]);</Text-field>
</Input>
</Group>
<Group labelreference="L130">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">#det_A := (int(int(det,xi[1]=-h[1]..h[1]),xi[2]=-h[2]..h[2]))/(h[1]*h[2]);
# This is for when we want to use the trapezoidal rule instead of really integrating
#det_A := 0;
#for i from 1 to d do
#  for j from 1 to d do
#    det_A := det_A + eval(eval(integrand_det,xi[1]=(-1)^i),xi[2]=(-1)^j);
#  end do
#end do;
# This is if we want to use det^2 instead of det
#det_A := (int(int(integrand_det^2,xi[1]=-h[1]..h[1]),xi[2]=-h[2]..h[2]))/(h[1]*h[2]);</Text-field>
</Input>
</Group>
<Group labelreference="L128" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">integrand_rec_det := 1/(Determinant(gradR(x,xi)) + sqrt(fac_reg^2+Determinant(gradR(x,xi))^2))^exponent_det;
rec_det_A := 0;
# Integrate the 1/det term over the Rumpf reference cell by the trapezoidal rule
for i from 1 to d do
  for j from 1 to d do
    # Just for checking what happens if we integrate over the vanilla reference cell
    # rec_det_A := rec_det_A + eval(eval((1./(integrand_det + sqrt(fac_reg^2+integrand_det^2))),xi[1]=(-1)^i),xi[2]=(-1)^j);
    # This is the right thing
    rec_det_A := rec_det_A + 1/4*eval(eval(integrand_rec_det,xi[1]=h[1]*(-1)^i),xi[2]=h[2]*(-1)^j);
  end do
end do;
#rec_det_A := (rec_det_A*1*1);
# Scale by the volume of the Rumpf reference cell
rec_det_A := (rec_det_A*(4*h[1]*h[2]))/(h[1]*h[2]);
# This would be the right thing to do, but Maple 16 cannot do it and gets stuck
#rec_det_A := int(int(1./(det + sqrt(fac_reg^2+det^2)),xi[1]=-h[1]..h[1]),xi[2]=-h[2]..h[2]);</Text-field>
</Input>
</Group>
<Group labelreference="L11" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" alignment="left" firstindent="0" spacebelow="0" leftmargin="0" linespacing="0.0" initial="0" linebreak="space" rightmargin="0" bulletsuffix="" spaceabove="0" bullet="none" pagebreak-before="false">frob_ := simplify(Trace(gradR(x,xi).Transpose(gradR(x,xi))));
integrand_norm := simplify((frob_ - d)^2);
norm_A := ((int(int(integrand_norm,xi[1]=-h[1]..h[1]),xi[2]=-h[2]..h[2]))/(h[1]*h[2]));
# Just for checking what happens if we integrate over the vanilla reference cell
#norm_A:= (int(int((a(x,xi)-2.)^2,xi[1]=-1..1),xi[2]=-1..1));</Text-field>
</Input>
</Group>
<Group labelreference="L158">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">rumpf:=fac_norm*norm_A + fac_det*det_A + fac_rec_det*rec_det_A;</Text-field>
</Input>
</Group>
<Group labelreference="L167" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">grad_rumpf := Matrix(nphi,d);
for i from 1 to d do
   for j from 1 to nphi do
      grad_rumpf[j,i] := diff(rumpf,x[j,i]);
   end do
end do;</Text-field>
</Input>
</Group>
<Group labelreference="L136" drawlabel="true" applyint="true" applyrational="true" applyexponent="false">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">der_h := fac_norm*diff(eval(norm_A,h[2]=h[1]),h[1]) + fac_det*diff(eval(det_A,h[2]=h[1]),h[1]) + fac_rec_det*diff(eval(rec_det_A,h[2]=h[1]),h[1]);</Text-field>
</Input>
</Group>
<Group labelreference="L155" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># Write the generated C code to file
# Use declare to avoid Maple explicitly casting stuff
# DEFINITELY use evalf if you see Maple casting something to int in the generated C code!
interface(echo=0);
writeto(&quot;maple_q1.txt&quot;);</Text-field>
</Input>
</Group>
<Group labelreference="L94">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">C((det_A),resultname=det_, declare=[fac_reg::numeric, h::numeric, x::numeric]);</Text-field>
</Input>
</Group>
<Group labelreference="L98" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">C((rec_det_A),resultname=rec_det_, declare=[fac_reg::numeric, h::numeric]);</Text-field>
</Input>
</Group>
<Group labelreference="L92" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">C((norm_A),resultname=norm_, declare=[fac_reg::numeric, h::numeric, x::numeric]);</Text-field>
</Input>
</Group>
<Group labelreference="L169" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">C(grad_rumpf,resultname=grad, declare=[fac_det::numeric, fac_rec_det::numeric, fac_norm::numeric, fac_reg::numeric, h::numeric, x::numeric]);</Text-field>
</Input>
</Group>
<Group labelreference="L90" drawlabel="true" applyint="true" applyrational="true" applyexponent="false">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">C(der_h,resultname=der_h_, declare=[fac_reg::numeric, x::numeric, h::numeric]);</Text-field>
</Input>
</Group>
<Group labelreference="L14" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># Restore output to terminal
writeto(terminal);</Text-field>
</Input>
</Group>
<Group labelreference="L32" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># Check the norm term's scaling
# x = xh means that the transformation is the identity mapping from the Rumpf reference cell to itself
eval(norm_A,x=xh);
# h=1 and x = xref means that the transformation is the identity mapping from the vanilla reference cell to itself
eval(eval(eval(norm_A,x=xref),h[1]=1),h[2]=1);
# Both should evaluate to 0</Text-field>
</Input>
</Group>
<Group labelreference="L33" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">eval(det_A, x = xh);
eval(eval(eval(det_A, x = xref), h[1] = 1), h[2] = 1);</Text-field>
</Input>
</Group>
<Group labelreference="L34" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">eval(rec_det_A, x = xh);
simplify(eval(eval(eval(rec_det_A, x = xref), h[1] = 1), h[2] = 1));</Text-field>
</Input>
</Group>
<Group labelreference="L161" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># In order for the functional to have a minimum if the transformation is the identity, it's gradient wrt. norm_A and det_A has to be zero.
# The norm_A part is, anyway, but for the det part, both terms have to be linked through a constant c depending on fac_reg
# This is the function of the determinant
f(t):= t^2 + c/(t + sqrt(fac_reg^2 + t^2))^2;</Text-field>
</Input>
</Group>
<Group labelreference="L162" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">df := eval(simplify(diff(f(t),t)), t = 1);
cs:=solve(df=0,c);</Text-field>
</Input>
</Group>
<Group labelreference="L147" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># Check if the scaling between the det and 1/det terms is right: The gradient wrt. x is supposed to be zero, so check some arbitrary partial derivatives
# The Real Thing (TM)
d11 := (diff(cs*det + 1/(det + sqrt(det^2 + fac_reg^2)),x[1,1]));</Text-field>
</Input>
</Group>
<Group labelreference="L149" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># But we compute this instead, so check if there is any difference
D11 := (diff(norm_A + cs*det_A + rec_det_A,x[1,1]));</Text-field>
</Input>
</Group>
<Group labelreference="L52" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># It might be more efficient to integrate both det and 1/det terms together by the trapezoidal rule, so check that case, too
D11_2 := 0;
for i from 1 to d do
  for j from 1 to d do
    D11_2 := D11_2 + eval(eval((cs*det + 1/(det + sqrt(fac_reg^2+det^2))),xi[1]=h[1]*(-1)^i),xi[2]=h[2]*(-1)^j);
  end do
end do;
D11_2 := norm_A + D11_2*h[1]*h[2];
D11_2 := diff(D11_2,x[1,1]); </Text-field>
</Input>
</Group>
<Group labelreference="L83" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># First one the the mapping from the Rumpf reference cell to itself, the second is the mapping of the vanilla reference cell to itself
# All these should evaluate to zero
simplify( eval(eval(d11,x=xh),fac_reg=fac_reg) );
simplify( eval(eval(eval(eval(d11,x=xref),h[1]=1),h[2]=1),fac_reg=fac_reg) );</Text-field>
</Input>
</Group>
<Group labelreference="L85" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># First one the the mapping from the Rumpf reference cell to itself, the second is the mapping of the vanilla reference cell to itself
# All these should evaluate to zero
simplify( eval(eval(D11,x=xh),fac_reg=fac_reg) );
simplify( eval(eval(eval(eval(D11,x=xref),h[1]=1),h[2]=1),fac_reg=fac_reg) );</Text-field>
</Input>
</Group>
<Group labelreference="L55" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># First one the the mapping from the Rumpf reference cell to itself, the second is the mapping of the vanilla reference cell to itself
# All these should evaluate to zero
simplify( eval(eval(D11_2,x=xh),fac_reg=fac_reg) );
simplify( eval(eval(eval(eval(D11_2,x=xref),h[1]=1),h[2]=1),fac_reg=fac_reg) );</Text-field>
</Input>
</Group>
<Group labelreference="L81" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"># Check if the derivative of the norm term is really zero, too
# First one the the mapping from the Rumpf reference cell to itself, the second is the mapping of the vanilla reference cell to itself
# All these should evaluate to zero
eval(diff( norm_A,x[1,1] ),x=xh);
eval(eval(eval(diff( norm_A,x[1,1] ),h[1]=1),h[2]=1),x=xref);</Text-field>
</Input>
</Group>
<Group labelreference="L156" drawlabel="true">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"></Text-field>
</Input>
</Group>
<Group labelreference="L163" drawlabel="true" applyint="true" applyrational="true" applyexponent="false">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">C(eval(det_A, [h[1]=1.,h[2]=1.]),declare=[x::numeric]);</Text-field>
</Input>
</Group>
<Group labelreference="L164" drawlabel="true" applyint="true" applyrational="true" applyexponent="false">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal">C(eval(2*grad_rumpf, [fac_norm = 0, fac_det=1, fac_rec_det=0, h[1]=1, h[2]=1]), resultname=grad);</Text-field>
</Input>
</Group>
<Group labelreference="L165" drawlabel="true" applyint="true" applyrational="true" applyexponent="false">
<Input>
<Text-field prompt="&gt; " style="Maple Input" layout="Normal"></Text-field>
</Input>
</Group>
</Worksheet>